<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LEMP Stack CICD Demo</title>
<base href="/cicd/">

<style>
body {
    font-family: Arial, sans-serif;
    max-width: 800px;
    margin: 50px auto;
    padding: 20px;
    background: #f5f5f5;
}

.container {
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

button {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    margin: 5px;
}

button:hover {
    background: #0056b3;
}

#result {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
    white-space: pre-wrap;
}
</style>

<!-- CHAT STYLES (SCOPED) -->
<style>
.chat-wrapper * {
    box-sizing: border-box;
}

.chat-container {
    max-width: 600px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    overflow: hidden;
}

.chat-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 16px;
    display: flex;
    gap: 10px;
    align-items: center;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: red;
}

.status-dot.connected {
    background: #4caf50;
}

.messages {
    height: 300px;
    overflow-y: auto;
    padding: 15px;
    background: #f8f9fa;
}

.message {
    margin-bottom: 10px;
}

.message.own {
    text-align: right;
}

.message-bubble {
    display: inline-block;
    padding: 10px 14px;
    border-radius: 14px;
    background: #e0e0e0;
}

.message.own .message-bubble {
    background: #667eea;
    color: white;
}

.message-meta {
    font-size: 0.75rem;
    color: #666;
}

.input-area {
    display: flex;
    gap: 8px;
    padding: 12px;
    border-top: 1px solid #ddd;
}

.nickname-input,
.message-input {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
}

.message-input {
    flex: 1;
}
</style>
</head>

<body>

<div class="container">
    <h1>LEMP Stack on CI/CD-putkessa!</h1>
    <p>Frontend: Nginx | Backend: Python/Flask | Database: MySQL</p>
    <p><strong>Server:</strong> <span id="serverInfo"></span></p>

    <button onclick="checkHealth()">Check Backend Health</button>
    <button onclick="initDB()">Initialize Database</button>
    <button onclick="getUsers()">Get Users</button>
    <button onclick="toggleChat()">Open Chat</button>

    <div id="result"></div>
</div>

<!-- CHAT -->
<div id="chatWrapper" class="chat-wrapper" style="display:none; margin-top:30px;">
    <div id="chatRoot"></div>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>
const serverInfo = document.getElementById("serverInfo");
const resultDiv = document.getElementById("result");
serverInfo.textContent = window.location.href;

async function safeFetch(url) {
    const res = await fetch(url);
    const text = await res.text();
    try {
        return JSON.parse(text);
    } catch {
        throw new Error(text);
    }
}

async function checkHealth() {
    try {
        const data = await safeFetch("api/health");
        resultDiv.textContent = JSON.stringify(data, null, 2);
    } catch (e) {
        resultDiv.textContent = e.message;
    }
}

async function initDB() {
    try {
        const data = await safeFetch("api/init-db");
        resultDiv.textContent = JSON.stringify(data, null, 2);
    } catch (e) {
        resultDiv.textContent = e.message;
    }
}

async function getUsers() {
    try {
        const data = await safeFetch("api/users");
        resultDiv.textContent = JSON.stringify(data, null, 2);
    } catch (e) {
        resultDiv.textContent = e.message;
    }
}
</script>

<script type="text/template" id="chatTemplate">
<div class="chat-container">
    <div class="chat-header">
        <div class="status-dot" id="statusDot"></div>
        <h3>MQTT Chat</h3>
    </div>
    <div class="messages" id="messages"></div>
    <div class="input-area">
        <input id="nickname" class="nickname-input" placeholder="Nick">
        <input id="messageInput" class="message-input" placeholder="Message" disabled>
        <button id="sendBtn" disabled>Send</button>
    </div>
</div>
</script>

<script>
let chatLoaded = false;

function toggleChat() {
    const wrapper = document.getElementById("chatWrapper");

    if (!chatLoaded) {
        document.getElementById("chatRoot").innerHTML =
            document.getElementById("chatTemplate").innerHTML;
        initChat();
        chatLoaded = true;
    }

    wrapper.style.display = wrapper.style.display === "none" ? "block" : "none";
}

function initChat() {
    const client = mqtt.connect(`ws://${location.hostname}/mqtt`, {
        clientId: "web_" + Math.random().toString(16).slice(2)
    });

    const messages = document.getElementById("messages");
    const input = document.getElementById("messageInput");
    const nick = document.getElementById("nickname");
    const send = document.getElementById("sendBtn");
    const dot = document.getElementById("statusDot");

    nick.value = localStorage.getItem("mqtt_nickname") || "";
    nick.onchange = () => localStorage.setItem("mqtt_nickname", nick.value);

    loadMessages();

    client.on("connect", () => {
        dot.classList.add("connected");
        input.disabled = false;
        send.disabled = false;
        client.subscribe("chat/messages");
    });

    client.on("message", (_, payload) => {
        const msg = JSON.parse(payload);
        addMessage(msg.nickname, msg.text, msg.clientId === client.options.clientId);
    });

    send.onclick = () => {
        if (!input.value) return;
        client.publish("chat/messages", JSON.stringify({
            nickname: nick.value || "Anon",
            text: input.value,
            clientId: client.options.clientId
        }));
        input.value = "";
    };
}

function addMessage(nick, text, own) {
    const div = document.createElement("div");
    div.className = "message" + (own ? " own" : "");
    div.innerHTML = `<div class="message-bubble">${text}</div><div class="message-meta">${nick}</div>`;
    document.getElementById("messages").appendChild(div);
}

async function loadMessages() {
    try {
        const response = await fetch(`http://${window.location.hostname}:5002/api/messages?limit=50`);
        const data = await response.json();

        data.forEach(msg => {
            addMessage(msg.nickname, msg.message, false);
        });
    } catch (err) {
        console.error("Failed to load messages:", err);
        addMessage("System", "Failed to load chat history.", false);
    }
}

</script>

</body>
</html>
